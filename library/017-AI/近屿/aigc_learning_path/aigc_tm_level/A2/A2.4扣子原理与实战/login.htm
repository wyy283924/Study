<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ojac学员登录</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 0;
        height: 100vh;
        /* 使body的高度为视口高度 */
        /* background: #dddddd; */
        background: linear-gradient(135deg, #71b7e6, #9b59b6);
      }

      .login {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: auto;
        /* 调整为自动高度 */
        width: 480px;
        background: #ffffff;
        /* padding: 30px 20px; */
        border-radius: 10px;
        box-shadow: 2px 2px 23px #0000001a;
        padding: 10px 30px 60px 30px;
      }

      .input-wrapper {
        position: relative;
        width: 100%;
        margin-bottom: 32px;
      }

      .label {
        position: absolute;
        top: 50%;
        left: 10px;
        font-size: 16px;
        font-weight: bold;
        color: rgba(0, 0, 0, 0.54);
        transition: transform 0.2s ease;
        transform-origin: 0 50%;
        cursor: text;
        transform: translateY(-50%);
      }

      .label--active {
        background: #fff;
        transform: translate3d(0, -180%, 0) scale(0.75);
        padding: 0 5px;
      }

      .input {
        width: calc(100% - 16px);
        height: 56px;
        padding: 0 8px;
        font-size: 16px;
        font-weight: 500;
        line-height: 1.5;
        border: none;
        outline: none;
        background-color: transparent;
        color: rgba(0, 0, 0, 0.87);
        border: 1px solid #dfe1e5;
        border-radius: 4px;
      }

      .input:focus {
        border-color: #4285f4;
      }

      .input:focus + .label,
      .input--active + .label {
        transform: translate3d(0, -180%, 0) scale(0.75);
        padding: 0 5px;
      }

      .code-btn {
        position: absolute;
        top: 0;
        right: 0;
        width: 120px;
        height: 56px;
        padding: 0 16px;
        border: none;
        outline: none;
        background-color: transparent;
        color: #1a73e8;
        font-size: 14px;
        font-weight: 500;
        line-height: 56px;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .code-btn:hover,
      .code-btn:active {
        color: #0d47a1;
      }

      .code-btn:disabled {
        color: rgba(0, 0, 0, 0.38);
        cursor: not-allowed;
      }

      .code--active {
        width: 150px;
      }

      .submit-btn {
        width: 100%;
        height: 48px;
        margin-top: 16px;
        border: none;
        outline: none;
        background-color: #1a73e8;
        color: #fff;
        font-size: 16px;
        font-weight: 500;
        line-height: 48px;
        cursor: pointer;
        transition: opacity 0.2s ease;
        opacity: 0.5;
        border-radius: 5px;
      }

      .submit-btn:hover {
        opacity: 0.8;
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .error {
        margin-top: 4px;
        font-size: 14px;
        font-weight: 500;
        color: #d93025;
        position: absolute;
      }

      .submit--error {
        position: relative;
      }

      .success-message {
        color: #28a745;
        font-size: 14px;
        margin-top: 4px;
      }
    </style>
    <style>
      .slider-section {
        display: none;
        /* 初始状态隐藏 */
        position: fixed;
        justify-content: center;
        align-items: center;
        left: 0;
        top: 0;
        height: 100vh;
        /* 使body的高度为视口高度 */
        width: 100vw;
        background: rgba(0, 0, 0, 0.5);
        /* 半透明背景 */
      }

      .slider-body {
        width: 300px;
        background: #ffffff;
        /* 设置背景颜色 */
        border: 1px solid #dbdce6;
        /* 添加边框 */
        border-radius: 10px;
        /* 添加圆角 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        /* 添加阴影 */
        padding: 30px;
      }

      .img-box {
        position: relative;
      }

      .bg-img {
        width: 300px;
        height: 200px;
      }

      .slider-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 40px;
        height: 40px;
      }

      .slider-box {
        position: relative;
        margin: 10px 0;
        width: 100%;
        height: 40px;
        background: #f8fafe;
        border: 1px solid #dbdce6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #666;
      }

      .slider-icon {
        position: absolute;
        left: 0;
        width: 40px;
        height: 40px;
        background: #fff;
        border: 1px solid #dbdce6;
        cursor: move;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .slider-icon::after {
        content: "\2192";
        /* Unicode right arrow */
        font-size: 20px;
        color: #666;
      }
    </style>
  </head>

  <body>
    <div class="login">
      <h2 style="margin-bottom: 30px; text-align: left; width: 100%">
        学员登录
      </h2>
      <div class="input-wrapper">
        <input
          class="input"
          type="tel"
          name="phone"
          id="phone"
          placeholder=" "
          onblur="handleBlur('phone')"
          oninput="handlePhoneInput()"
          onfocus="handleFocus('phone')"
        />
        <label class="label" id="phone-label" for="phone">请输入手机号</label>
        <div id="phone-error" class="error"></div>
      </div>
      <div class="input-wrapper">
        <input
          class="input"
          type="text"
          name="code"
          id="code"
          placeholder=" "
          onblur="handleBlur('code')"
          oninput="handleCodeInput()"
          onfocus="handleFocus('code')"
        />
        <label class="label" id="code-label" for="code">请输入验证码</label>
        <button class="code-btn" id="code-btn" onclick="sendSmsClick()">
          获取验证码
        </button>
        <div id="code-error" class="error"></div>
        <!-- <div id="success-message" class="success-message"></div> -->
      </div>
      <button class="submit-btn" id="submit-btn" onclick="handleSubmit()">
        登录
      </button>
      <div id="submit-error" class="error submit--error"></div>
    </div>
    <div class="slider-section">
      <div class="slider-body">
        <button
          onclick="document.querySelector('.slider-section').style.display = 'none'"
        >
          关闭
        </button>
        <!-- 关闭按钮 -->
        <button onclick="init()">刷新</button>
        <div class="img-box">
          <img id="bgImg" class="bg-img" src="" />
          <img id="sliderImg" class="slider-img" src="" />
        </div>
        <div id="sliderBox" class="slider-box">
          <p id="sliderText">向右滑动滑块填充拼图</p>
          <div id="sliderIcon" class="slider-icon"></div>
        </div>
      </div>
    </div>
    <script>
      // 添加域名映射工具方法
      function getContainerName(hostname) {
        const domainMap = {
          'ojaca2.jinyuzhineng.com': 'jupyterhubA2',
          'ojaca3.jinyuzhineng.com': 'jupyterhubA3',
          'ojaca4.jinyuzhineng.com': 'jupyterhubA4',
          'ojaca.jinyuzhineng.com': 'jupyterhubOldA',
          'ojacb1.jinyuzhineng.com': 'jupyterhubB1',
          'ojacb2.jinyuzhineng.com': 'jupyterhubB2',
          'ojacb3.jinyuzhineng.com': 'jupyterhubB3',
          'ojacb4.jinyuzhineng.com': 'jupyterhubB4',
          'ojacc.jinyuzhineng.com': 'jupyterhubC',
          'ojacc4.jinyuzhineng.com': 'jupyterhubC4',
          'ojacc5.jinyuzhineng.com': 'jupyterhubC5',
          'ojacc6.jinyuzhineng.com': 'jupyterhubC6',
          'jyipm.jinyuzhineng.com': 'jupyterhubnewc1',
          'ojacpm.jinyuzhineng.com': 'jupyterhubnewc2',
          'pm123.jinyuzhineng.com': 'jupyterhubnewc3',
          'ojacadt.jinyuzhineng.com': 'jupyterhub',
        };
        return domainMap[hostname] || 'jupyterhubA2';
      }

      let phone = document.getElementById("phone");
      let code = document.getElementById("code");
      let isPhoneActive = false;
      let isCodeActive = false;
      let codeBtnDisabled = false;
      let submitBtnDisabled = true;

      function handleFocus(inputId) {
        document
          .getElementById(inputId + "-label")
          .classList.add("label--active");
      }

      function handleBlur(inputId) {
        const input = document.getElementById(inputId);
        if (!input.value) {
          document
            .getElementById(inputId + "-label")
            .classList.remove("label--active");
        }
      }

      function handlePhoneInput() {
        document.getElementById("phone-error").textContent =
          validatePhone() || "";
        updateSubmitBtnDisabled();
        isPhoneActive = true;
      }

      function handleCodeInput() {
        document.getElementById("code-error").textContent =
          validateCode() || "";
        updateSubmitBtnDisabled();
        isCodeActive = true;
      }

      function sendSmsClick() {
        let phoneError = validatePhone() || "";
        if (phoneError) {
          document.getElementById("phone-error").textContent = phoneError;
          return;
        }
        init(); // 初始化
      }

      // 在脚本最开头立即处理错误参数
      (function checkErrorParam() {
        const urlParams = new URLSearchParams(window.location.search);
        const errorCode = urlParams.get('error');
        
        if (errorCode) {
          // 立即清除参数防止刷新重复提示
          const newUrl = window.location.pathname + window.location.hash;
          window.history.replaceState(null, '', newUrl);
          
          // 显示错误提示
          const errorElement = document.getElementById("submit-error");
          errorElement.textContent = "账户不存在，请联系学管开通";
          
          setTimeout(() => {
            errorElement.textContent = "";
          }, 5000);
        }
      })();

      async function getXsrfToken() {
        try {
          const response = await fetch('/hub/login');
          const text = await response.text();
          const match = text.match(/xsrf_token: "([^"]+)"/);
          return match ? match[1] : '';
        } catch (error) {
          console.error('获取 XSRF token 失败:', error);
          return '';
        }
      }

      async function handleSubmit() {
            if (validatePhone() || validateCode()) {
              validatePhone() ? handlePhoneInput() : handleCodeInput() 
              return;
            }
            
            try {
              // 获取 XSRF token
              const xsrfToken = await getXsrfToken();
              
              // 直接提交表单到 JupyterHub
              const form = document.createElement('form');
              form.method = 'post';
              form.action = '/hub/login';
          
              // 确保 XSRF token 正确设置
              const xsrfInput = document.createElement('input');
              xsrfInput.type = 'hidden';
              xsrfInput.name = '_xsrf';
              xsrfInput.value = document.cookie.split('_xsrf=')[1].split(';')[0];
              form.appendChild(xsrfInput);
          
              // 添加用户名字段（使用手机号作为用户名）
              const usernameInput = document.createElement('input');
              usernameInput.type = 'hidden';
              usernameInput.name = 'username';
              usernameInput.value = phone.value;
              form.appendChild(usernameInput);
          
              // 添加密码字段（使用验证码作为密码）
              const passwordInput = document.createElement('input');
              passwordInput.type = 'hidden';
              passwordInput.name = 'password';
              passwordInput.value = code.value;
              form.appendChild(passwordInput);
          
              // 添加到页面并提交
              document.body.appendChild(form);
              form.submit();
            } catch (error) {
              console.error('Error:', error);
              document.getElementById("submit-error").textContent = '登录失败，请重试';
            }
          }

      function validatePhone() {
        if (!phone.value) {
          return "手机号不能为空";
        }
        if (!/^\d{11}$/.test(phone.value)) {
          return "手机号格式不正确";
        }
        return "";
      }

      function validateCode() {
        if (!code.value) {
          return "验证码不能为空";
        }
        return "";
      }

      function updateSubmitBtnDisabled() {
        document.getElementById("submit-error").textContent = "";
        submitBtnDisabled =
          !!document.getElementById("phone-error").textContent ||
          !!document.getElementById("code-error").textContent;
        document.getElementById("submit-btn").disabled = submitBtnDisabled;
      }
      function sendSmsSucess() {
        // 验证码发送成功
        document.querySelector(".slider-section").style.display = "none";
        document.getElementById("code-btn").disabled = true; // 禁用按钮
        let countdown = 60; // 倒计时60秒
        const countdownInterval = setInterval(() => {
          if (countdown > 0) {
            document.getElementById(
              "code-btn"
            ).textContent = `重新发送(${countdown})`;
            countdown--;
          } else {
            clearInterval(countdownInterval);
            document.getElementById("code-btn").textContent = "获取验证码";
            document.getElementById("code-btn").disabled = false; // 启用按钮
          }
        }, 1000);
        console.log("发送验证码成功");
      }

      let sliderIcon = document.getElementById("sliderIcon");
      let sliderBox = document.getElementById("sliderBox");
      let sliderText = document.getElementById("sliderText");
      let sliderImg = document.getElementById("sliderImg");
      let bgImg = document.getElementById("bgImg");
      let disX = 0;
      let maxMove = 260;

      function getApiDomain(hostname) {
        // 检查hostname是否在映射列表中
        const domainMap = {
          'ojaca2.jinyuzhineng.com': true,
          'ojaca3.jinyuzhineng.com': true,
          'ojaca4.jinyuzhineng.com': true,
          'ojaca.jinyuzhineng.com': true,
          'ojacb1.jinyuzhineng.com': true,
          'ojacb2.jinyuzhineng.com': true,
          'ojacb3.jinyuzhineng.com': true,
          'ojacb4.jinyuzhineng.com': true,
          'ojacc.jinyuzhineng.com': true,
          'ojacc4.jinyuzhineng.com': true,
          'ojacc5.jinyuzhineng.com': true,
          'ojacc6.jinyuzhineng.com': true,
          'jyipm.jinyuzhineng.com': true,
          'ojacpm.jinyuzhineng.com': true,
          'pm123.jinyuzhineng.com': true,
          'ojacadt.jinyuzhineng.com': true,
        };
        return domainMap[hostname] ? 'hr.aidexianzhaopinguan.com' : 'mini.aidexianzhaopinguan.com';
      }

      function init() {
        const apiDomain = getApiDomain(window.location.hostname);
        let fetchUrl = `https://${apiDomain}/admin/login/imageSlideValid?phone=${phone.value}`;
        fetch(fetchUrl) // 使用提供的接口
          .then((response) => response.json())
          .then((res) => {
            const data = res.data;
            console.log(data);
            bgImg.src = "data:image/png;base64," + data.backgroundImg;
            sliderImg.src = "data:image/png;base64," + data.sliderImg;
            sliderImg.style.top = data.height + "px";
            sliderImg.style.left = "0px";
            disX = 0;
            sliderIcon.style.transform = "translateX(0)";
            sliderText.innerText = "向右滑动滑块填充拼图";
            sliderBox.style.background = "#F8FAFE";
            sliderBox.style.color = "#666";
            document.querySelector(".slider-section").style.display = "flex"; // 显示弹窗
          })
          .catch((error) => console.error("Error:", error));
      }

      sliderIcon.addEventListener("mousedown", (e) => {
        let startX = e.clientX;

        function moveHandler(event) {
          disX = event.clientX - startX;
          if (disX < 0) disX = 0;
          if (disX > maxMove) disX = maxMove;
          sliderIcon.style.transform = `translateX(${disX}px)`;
          sliderImg.style.left = disX + "px";
        }

        function upHandler() {
          document.removeEventListener("mousemove", moveHandler);
          document.removeEventListener("mouseup", upHandler);
          verifySlide();
        }

        document.addEventListener("mousemove", moveHandler);
        document.addEventListener("mouseup", upHandler);
      });

      function verifySlide() {
        const apiDomain = getApiDomain(window.location.hostname);
        let formData = new FormData();
        formData.append("prefixPhone", "86");
        formData.append("phone", phone.value);
        formData.append("smsType", "2");
        formData.append("clientType", "9");
        formData.append("validImgCode", disX);

        fetch(`https://${apiDomain}/admin/login/sendSms`, {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data && data.code === 0) {
              sliderText.innerText = "验证成功";
              sliderBox.style.background = "#F1FFF2";
              sliderBox.style.color = "#74C75E";
              setTimeout(sendSmsSucess, 1000);
            } else {
              sliderText.innerText = "验证失败";
              sliderBox.style.background = "#FFD9D9";
              sliderBox.style.color = "#FF5F5F";
              setTimeout(init, 1000);
            }
          })
          .catch((error) => console.error("Error:", error));
      }
    </script>
  </body>
</html>