## 手写模拟Spring

1. 手写模拟Spring容器启动过程底层实现

   首先扫描，将带有Component注解的类添加到beanDefinitionMap中，接着遍历beanDefinitionMap，判断单例、懒加载创建bean并添加到singletonObjects中。

2. 手写模拟Spring解析配置底层实现

3. 手写模拟Spring扫描Bean过程底层实现

4. 手写模拟Bean生命周期创建过程底层实现

5. 手写模拟Bean生命周期依赖注入过程底层实现

6. 手写模拟Bean生命周期Aware回调过程底层实现

7. 手写模拟Bean生命周期初始化过程底层实现

8. 手写模拟BeanDefinition生成过程底层实现

9. 手写模拟@Component、@ComponentScan

10. 手写模拟@Autowired、@PostConstruct

11. 手写模拟BeanPostProcessor后置处理底层实现

12. 手写模拟Spring AOP过程底层实现

13. 手写模拟Pointcut、Advisor、Advice底层实现

### 接口

#### ApplicationContext

```java
public interface ApplicationContext {
    public Object getBean(String beanName);
}
```

#### ApplicationContextAware

```java
public interface ApplicationContextAware {
    void setApplicationContextAware(ApplicationContext applicationContext);
}
```

#### BeanNameAware

```java
public interface BeanNameAware {
    void setBeanName(String name);
}
```

#### BeanPostProcessor

```java
public interface BeanPostProcessor {

    default Object postProcessBeforeInitialization(Object bean, String beanName) {
        return bean;
    }

    default Object postProcessAfterInitialization(Object bean, String beanName) {
        return bean;
    }
}
```

#### InitializingBean

```java
public interface InitializingBean {

    void afterPropertiesSet();
}
```



### 类

#### WYYApplicationContext

```java
public class WYYApplicationContext implements ApplicationContext
{
    //存储Spring中到底有哪些Bean的
    private Map<String,BeanDefinition> beanDefinitionMap = new HashMap<>();
    //单例池
    private Map<String,Object> singletonObjects = new HashMap<>();
    //
    private List<BeanPostProcessor> beanPostProcessorList = new ArrayList<>();
    /**
    * 容器启动
    */
    public WYYApplicationContext(Class<?> configClass){
        scan(configClass);


        for (Map.Entry<String, BeanDefinition> beanDefinitionEntry : beanDefinitionMap.entrySet()) {
            String beanName = beanDefinitionEntry.getKey();
            BeanDefinition beanDefinition = beanDefinitionEntry.getValue();
            if(BeanPostProcessor.class.isAssignableFrom(beanDefinition.getBeanClass())){
                beanPostProcessorList.add((BeanPostProcessor) createBean(beanName,beanDefinition));
            }
        }
        beanPostProcessorList.add(new AopBeanPostProcessor());
        for (Map.Entry<String, BeanDefinition> beanDefinitionEntry : beanDefinitionMap.entrySet()) {
            String beanName = beanDefinitionEntry.getKey();
            BeanDefinition beanDefinition = beanDefinitionEntry.getValue();
//判断单例、懒加载
            if(beanDefinition.getScope().equals("singleton") && !beanDefinition.isLazy()){
                if(!BeanPostProcessor.class.isAssignableFrom(beanDefinition.getBeanClass())){
                    Object singleton = createBean(beanName,beanDefinition);
                    singletonObjects.put(beanName,singleton);
                }

            }
        }
    }

    //Bean生命周期
    //通过beanDefinition对象反射获取bean
    public Object createBean(String beanName,BeanDefinition beanDefinition){
        Class beanClass = beanDefinition.getBeanClass();
        try {
            //实例化
            Object instance = beanClass.getConstructor().newInstance();
            //依赖注入 填充bean
            for (Field declaredField : beanClass.getDeclaredFields()) {
                if(declaredField.isAnnotationPresent(Autowired.class)){
                    String name = declaredField.getName();
                    declaredField.setAccessible(true);
                    declaredField.set(instance,getBean(name));
                }
            }
            //初始化前
            for (Method method : beanClass.getDeclaredMethods()) {
                if(method.isAnnotationPresent(PostConstruct.class)){
                    method.invoke(instance);
                }
            }
            //初始化
            if(instance instanceof InitializingBean){
                ((InitializingBean) instance).afterPropertiesSet();
            }
            if(instance instanceof BeanNameAware beanNameAware){
                beanNameAware.setBeanName(beanName);
            }
            if(instance instanceof ApplicationContextAware applicationContextAware){
                applicationContextAware.setApplicationContextAware(this);
            }
            //初始化后
            for (BeanPostProcessor beanPostProcessor : beanPostProcessorList) {
                instance = beanPostProcessor.postProcessAfterInitialization(instance, beanName);
            }

            return instance;
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    private void scan(Class<?> configClass) {
        //解析配置类
        if(configClass.isAnnotationPresent(ComponentScan.class)){
            ComponentScan componentScanAnnotation = configClass.getAnnotation(ComponentScan.class);
            String path = componentScanAnnotation.value();//com.wyy.service
            path = path.replace(".","/");//com\wyy\service
            //扫描 ASM 反射
            ClassLoader classLoader = this.getClass().getClassLoader();
            URL resource = classLoader.getResource(path);
            File file = new File(resource.getFile());

            for(File file1 : file.listFiles()){
                String classPath = file1.getPath();
                classPath = classPath.substring(classPath.indexOf("com"),classPath.lastIndexOf(".class")).replace("\\",".");
                try {
                    Class<?> clazz = classLoader.loadClass(classPath);
                    if(clazz.isAnnotationPresent(Component.class)){
                        //代表是一个bean
                        Component componentAnnotation = clazz.getAnnotation(Component.class);
                        String beanName = componentAnnotation.value();

                        BeanDefinition beanDefinition = new BeanDefinition();
                        beanDefinition.setBeanClass(clazz);
                        beanDefinition.setLazy(false);
                        if(clazz.isAnnotationPresent(Scope.class)){
                            beanDefinition.setScope(clazz.getAnnotation(Scope.class).value());
                        }else{
                            beanDefinition.setScope("singleton");
                        }

                        beanDefinitionMap.put(beanName,beanDefinition);
                    }
                } catch (ClassNotFoundException e) {
                    throw new RuntimeException(e);
                }
            }
        }
    }
	//获取bean
    public Object getBean(String beanName){
        if (!beanDefinitionMap.containsKey(beanName)) {
            throw new RuntimeException("不存在这个bean");
        }

        BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);

        if(beanDefinition.getScope().equals("singleton")){
            if (!beanDefinition.isLazy()) {
                return singletonObjects.get(beanName);
            }else{
                Object singleton = createBean(beanName,beanDefinition);
                singletonObjects.put(beanName,singleton);
            }
        }else{
            return createBean(beanName,beanDefinition);
        }
        return null;
    }
}

```



#### WYYAdvisor

```java
public class WYYAdvisor {
    private String pointcut;
    private Method advice;
    private Object aspect;

    public ZhouyuAdvisor(String pointcut, Method advice, Object aspect) {
        this.pointcut = pointcut;
        this.advice = advice;
        this.aspect = aspect;
    }

    public String getPointcut() {
        return pointcut;
    }

    public void setPointcut(String pointcut) {
        this.pointcut = pointcut;
    }

    public Method getAdvice() {
        return advice;
    }

    public void setAdvice(Method advice) {
        this.advice = advice;
    }

    public Object getAspect() {
        return aspect;
    }

    public void setAspect(Object aspect) {
        this.aspect = aspect;
    }
}
```

#### BeanDefinition

```java
public class BeanDefinition {

    private Class beanClass;
    private String scope;
    private Boolean isLazy;

    public Class getBeanClass() {
        return beanClass;
    }

    public void setBeanClass(Class beanClass) {
        this.beanClass = beanClass;
    }

    public String getScope() {
        return scope;
    }

    public void setScope(String scope) {
        this.scope = scope;
    }

    public Boolean getLazy() {
        return isLazy;
    }

    public void setLazy(Boolean lazy) {
        isLazy = lazy;
    }
}
```

#### AopBeanPostProcessor

```java
public class AopBeanPostProcessor implements BeanPostProcessor {

    private List<ZhouyuAdvisor> advisors = new ArrayList<>();

    public AopBeanPostProcessor(ApplicationContext applicationContext) {

        for (Map.Entry<String, BeanDefinition> beanDefinitionEntry : applicationContext.getBeanDefinitionMap().entrySet()) {
            String beanName = beanDefinitionEntry.getKey();
            BeanDefinition beanDefinition = beanDefinitionEntry.getValue();
            Class<?> beanClass = beanDefinition.getBeanClass();

            if (beanClass.isAnnotationPresent(Aspect.class)) {
                for (Method method : beanClass.getDeclaredMethods()) {
                    if (method.isAnnotationPresent(Before.class)) {
                        Before beforeAnnotation = method.getAnnotation(Before.class);
                        String pointcut = beforeAnnotation.value();
                        ZhouyuAdvisor zhouyuAdvisor = new ZhouyuAdvisor(pointcut, method, applicationContext.getBean(beanName));
                        advisors.add(zhouyuAdvisor);
                    }
                }
            }
        }
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) {
        System.out.println("beanPostProcessor...");
        for (ZhouyuAdvisor advisor : advisors) {
            Method advice = advisor.getAdvice();
            String pointcut = advisor.getPointcut();

            // pointcut匹配，需要进行aop
            if (pointcut.contains(bean.getClass().getSimpleName())) {
                Enhancer enhancer = new Enhancer();
                enhancer.setSuperclass(bean.getClass());
                enhancer.setCallback(new MethodInterceptor() {
                    @Override
                    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {

                        // 执行切面逻辑
                        advice.invoke(advisor.getAspect(), null);

                        // 执行原本逻辑
                        return method.invoke(bean, objects);
                    }
                });
                return enhancer.create();
            }
        }

        return bean;
    }
}
```



### 注解

#### @Autowired

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
public @interface Autowired {

}
```

#### @Component

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface Component {
    String value() default "";
}
```

#### @ComponentScan

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface ComponentScan {
    String value() default "";
}
```

#### @PostConstruct

```java
@Retention(RUNTIME)
@Target(METHOD)
public @interface PostConstruct {
}
```

#### @Scope

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface Scope {
    String value() default "";
}
```

